---
- name: Upgrade Raspberry Pi to the latest Ubuntu LTS
  hosts: raspberry_pi_boxes
  become: true
  gather_facts: true
  tasks:
    - name: Require explicit confirmation before upgrading
      ansible.builtin.assert:
        that:
          - lts_upgrade_confirm is defined
          - lts_upgrade_confirm | bool
        fail_msg: >-
          Set -e lts_upgrade_confirm=true to run the LTS upgrade.
      tags: [lts_upgrade]

    - name: Ensure update-manager-core is installed
      ansible.builtin.apt:
        name: update-manager-core
        state: present
        update_cache: true
      tags: [lts_upgrade]

    - name: Ensure LTS upgrades are enabled
      ansible.builtin.lineinfile:
        path: /etc/update-manager/release-upgrades
        regexp: '^Prompt='
        line: 'Prompt=lts'
        create: true
        mode: '0644'
      tags: [lts_upgrade]

    - name: Check for available LTS release
      ansible.builtin.command: do-release-upgrade -c
      register: lts_upgrade_check
      changed_when: false
      tags: [lts_upgrade]

    - name: Stop if no new LTS release is available
      ansible.builtin.fail:
        msg: "No new LTS release is available for this host."
      when: "'No new release found' in lts_upgrade_check.stdout"
      tags: [lts_upgrade]

    - name: Run the non-interactive LTS upgrade (expect a disconnect/reboot)
      ansible.builtin.command: do-release-upgrade -f DistUpgradeViewNonInteractive
      environment:
        DEBIAN_FRONTEND: noninteractive
      tags: [lts_upgrade]
