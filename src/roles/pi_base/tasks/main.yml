---
# Baseline OS prep for Raspberry Pi hosts.

- name: Refresh apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 0
  changed_when: false
  tags: [pi_base, updates]

- name: Upgrade all packages to the latest release (dist-upgrade)
  ansible.builtin.apt:
    upgrade: dist
    autoremove: true
  register: pi_base_upgrade
  tags: [pi_base, updates]

- name: Check if reboot is required after upgrades
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: pi_base_reboot_required
  tags: [pi_base, updates]

- name: Reboot if the kernel or critical packages changed
  ansible.builtin.reboot:
    msg: "Rebooting after package upgrades"
    connect_timeout: 30
    reboot_timeout: 600
    test_command: whoami
  when: pi_base_reboot_required.stat.exists
  tags: [pi_base, updates]

- name: Ensure required pi_base variables are provided
  ansible.builtin.assert:
    that:
      - pi_base_admin_user is defined
      - pi_base_admin_user | length > 0
      - pi_base_admin_ssh_public_key_file is defined
      - pi_base_admin_ssh_public_key_file | length > 0
      - pi_base_allow_passwordless_sudo is defined
      - pi_base_allow_passwordless_sudo | string | length > 0
      - pi_base_allow_passwordless_sudo | lower in ['true', 'false', '1', '0']
      - pi_base_hostname is defined
      - pi_base_hostname | length > 0
      - pi_base_timezone is defined
      - pi_base_timezone | length > 0
      - pi_base_locale is defined
      - pi_base_locale | length > 0
      - pi_base_disable_resolved_stub is defined
      - pi_base_resolv_conf_target is defined
      - pi_base_resolv_conf_target | length > 0
    fail_msg: "Define required pi_base_* variables before applying this role."
  tags: [pi_base, access]

- name: Check admin SSH public key file exists
  ansible.builtin.stat:
    path: "{{ pi_base_admin_ssh_public_key_file | expanduser }}"
  delegate_to: localhost
  become: false
  register: pi_base_admin_ssh_key_stat
  tags: [pi_base, access]

- name: Fail if admin SSH public key file is missing
  ansible.builtin.assert:
    that:
      - pi_base_admin_ssh_key_stat.stat.exists
      - pi_base_admin_ssh_key_stat.stat.isreg
    fail_msg: >-
      Admin SSH public key file not found or not a regular file:
      {{ pi_base_admin_ssh_public_key_file }}
      (expanded: {{ pi_base_admin_ssh_public_key_file | expanduser }})
  delegate_to: localhost
  become: false
  tags: [pi_base, access]

- name: Load admin SSH public key from file
  ansible.builtin.set_fact:
    pi_base_admin_ssh_public_key: >-
      {{
        lookup(
          'file',
          pi_base_admin_ssh_public_key_file | expanduser
        ) | trim
      }}
  tags: [pi_base, access]

- name: Ensure admin user exists with sudo access
  ansible.builtin.user:
    name: "{{ pi_base_admin_user }}"
    groups: sudo
    append: true
    shell: /bin/bash
    create_home: true
    state: present
  tags: [pi_base, access]

- name: Ensure admin user authorized key is present
  ansible.posix.authorized_key:
    user: "{{ pi_base_admin_user }}"
    key: "{{ pi_base_admin_ssh_public_key }}"
    state: present
  tags: [pi_base, access]

- name: Allow passwordless sudo for admin user (opt-in)
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/90-{{ pi_base_admin_user }}"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
    content: "{{ pi_base_admin_user }} ALL=(ALL) NOPASSWD:ALL\n"
  when: pi_base_allow_passwordless_sudo | bool
  tags: [pi_base, access]

- name: Ensure passwordless sudo is not enabled for admin user (opt-out)
  ansible.builtin.file:
    path: "/etc/sudoers.d/90-{{ pi_base_admin_user }}"
    state: absent
  when: not (pi_base_allow_passwordless_sudo | bool)
  tags: [pi_base, access]

- name: Set system hostname
  ansible.builtin.hostname:
    name: "{{ pi_base_hostname }}"
  tags: [pi_base, identity]

- name: Set system timezone
  community.general.timezone:
    name: "{{ pi_base_timezone }}"
  tags: [pi_base, identity]

- name: Ensure locales package is installed
  ansible.builtin.apt:
    name: locales
    state: present
  tags: [pi_base, identity]

- name: Ensure locale is generated
  community.general.locale_gen:
    name: "{{ pi_base_locale }}"
    state: present
  tags: [pi_base, identity]

- name: Set default locale
  ansible.builtin.copy:
    dest: /etc/default/locale
    owner: root
    group: root
    mode: "0644"
    content: "LANG={{ pi_base_locale }}\n"
  tags: [pi_base, identity]

- name: Ensure sshd drop-in directory exists
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [pi_base, access]

- name: Configure SSH hardening via drop-in (Ubuntu 22.04+)
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config.d/90-pi-base-hardening.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      PubkeyAuthentication yes
  notify: Restart ssh
  tags: [pi_base, access]

- name: Validate sshd configuration
  ansible.builtin.command:
    cmd: /usr/sbin/sshd -t
  changed_when: false
  tags: [pi_base, access]

- name: Ensure systemd-resolved drop-in directory exists
  ansible.builtin.file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: pi_base_disable_resolved_stub | bool
  tags: [pi_base, dns]

- name: Disable systemd-resolved stub listener for DNS
  ansible.builtin.copy:
    dest: /etc/systemd/resolved.conf.d/disable-stub.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [Resolve]
      DNSStubListener=no
  when: pi_base_disable_resolved_stub | bool
  notify: Restart systemd-resolved
  tags: [pi_base, dns]

- name: Ensure resolv.conf points to systemd-resolved output
  ansible.builtin.file:
    src: "{{ pi_base_resolv_conf_target }}"
    dest: /etc/resolv.conf
    state: link
    force: true
  when: pi_base_disable_resolved_stub | bool
  tags: [pi_base, dns]
