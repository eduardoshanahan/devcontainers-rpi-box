---
- name: Ensure required docker_engine variables are provided
  ansible.builtin.assert:
    that:
      - docker_engine_data_root is defined
      - docker_engine_data_root | length > 0
      - docker_engine_log_max_size is defined
      - docker_engine_log_max_size | length > 0
      - docker_engine_log_max_file is defined
      - docker_engine_log_max_file | length > 0
      - docker_engine_users is defined
      - docker_engine_users | length > 0
      - docker_engine_apt_release is defined
      - docker_engine_apt_release | length > 0
      - docker_engine_version is defined
      - docker_engine_compose_version is defined
    fail_msg: >-
      Define required docker_engine_* variables before applying this role.
  tags: [docker_engine]

- name: Install Docker apt prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  tags: [docker_engine]

- name: Determine Docker apt architecture
  ansible.builtin.set_fact:
    docker_engine_arch: >-
      {{ docker_engine_arch_map.get(ansible_architecture,
      ansible_architecture) }}
  vars:
    docker_engine_arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armhf
  tags: [docker_engine]

- name: Ensure Docker apt keyring directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Download Docker apt GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
  tags: [docker_engine]

- name: Install Docker apt GPG keyring
  ansible.builtin.command:
    cmd: >-
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      /etc/apt/keyrings/docker.asc
    creates: /etc/apt/keyrings/docker.gpg
  tags: [docker_engine]

- name: Ensure Docker apt keyring permissions
  ansible.builtin.file:
    path: /etc/apt/keyrings/docker.gpg
    owner: root
    group: root
    mode: "0644"
  tags: [docker_engine]

- name: Add Docker apt repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ docker_engine_arch }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu
      {{ docker_engine_apt_release }} stable
    filename: docker
    state: present
    update_cache: false
  tags: [docker_engine]

- name: Refresh apt cache after adding Docker repo
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  register: docker_engine_cache_update
  retries: 3
  delay: 5
  until: docker_engine_cache_update is succeeded
  tags: [docker_engine]

- name: Check Docker apt repo availability
  ansible.builtin.command:
    cmd: apt-cache policy docker-ce
  register: docker_engine_repo_check
  changed_when: false
  retries: 5
  delay: 5
  until: "'Candidate: (none)' not in docker_engine_repo_check.stdout"
  tags: [docker_engine]

- name: Fail if Docker packages are unavailable
  ansible.builtin.fail:
    msg: >-
      Docker apt repo is configured but docker-ce is not available. Check apt
      update output or set docker_engine_apt_release to a supported Ubuntu
      codename (e.g., jammy).
  when: "'Candidate: (none)' in docker_engine_repo_check.stdout"
  tags: [docker_engine]

- name: Gather containerd.io candidate from Docker repo
  ansible.builtin.command:
    cmd: sh -c "apt-cache policy containerd.io | awk '/Candidate:/ {print $2}'"
  register: docker_engine_containerd_candidate_raw
  changed_when: false
  tags: [docker_engine]

- name: Gather containerd.io version list from Docker repo
  ansible.builtin.command:
    cmd: >-
      sh -c "apt-cache policy containerd.io
      | sed -n 's/^[[:space:]]*\\([0-9][0-9.]*[^ ]*\\).*/\\1/p'
      | awk '/\\./'"
  register: docker_engine_containerd_versions_raw
  changed_when: false
  tags: [docker_engine]

- name: Parse containerd.io candidate and version list
  ansible.builtin.set_fact:
    docker_engine_containerd_candidate: >-
      {{ docker_engine_containerd_candidate_raw.stdout | trim }}
    docker_engine_containerd_versions: >-
      {{ docker_engine_containerd_versions_raw.stdout_lines
      | select('string')
      | map('trim')
      | select('match', '[0-9]')
      | list }}
  tags: [docker_engine]

- name: Fail if containerd.io candidate is unavailable
  ansible.builtin.fail:
    msg: >-
      No containerd.io candidate found in apt policy. Verify repository
      connectivity and metadata.
  when: docker_engine_containerd_candidate is not defined or docker_engine_containerd_candidate | length == 0
  tags: [docker_engine]

- name: Fail if containerd.io versions are unavailable
  ansible.builtin.fail:
    msg: >-
      No containerd.io versions found via apt policy. Verify repository
      connectivity and metadata.
  when: docker_engine_containerd_versions | length == 0
  tags: [docker_engine]

- name: Install containerd.io candidate from Docker repo
  ansible.builtin.apt:
    name: "containerd.io={{ docker_engine_containerd_candidate }}"
    state: present
    update_cache: true
    cache_valid_time: 0
    force_apt_get: true
  register: docker_engine_containerd_install_attempt
  ignore_errors: true
  tags: [docker_engine]

- name: Check installed containerd.io version
  ansible.builtin.command:
    cmd: dpkg-query -W -f='${Version}' containerd.io
  register: docker_engine_containerd_installed_raw
  changed_when: false
  failed_when: false
  tags: [docker_engine]

- name: Record installed containerd.io version (if present)
  ansible.builtin.set_fact:
    docker_engine_containerd_installed_version: >-
      {{ docker_engine_containerd_installed_raw.stdout | trim }}
  tags: [docker_engine]

- name: Install containerd.io from policy versions (fallback)
  ansible.builtin.include_tasks: install_containerd_version.yml
  loop: >-
    {{ docker_engine_containerd_versions
    | reject('equalto', docker_engine_containerd_candidate)
    | list }}
  loop_control:
    loop_var: docker_engine_containerd_version
  when: (docker_engine_containerd_installed_version | default('')) | length == 0
  tags: [docker_engine]

- name: Re-check installed containerd.io version after fallback
  ansible.builtin.command:
    cmd: dpkg-query -W -f='${Version}' containerd.io
  register: docker_engine_containerd_installed_raw_after
  changed_when: false
  failed_when: false
  when: (docker_engine_containerd_installed_version | default('')) | length == 0
  tags: [docker_engine]

- name: Record installed containerd.io version after fallback
  ansible.builtin.set_fact:
    docker_engine_containerd_installed_version: >-
      {{ docker_engine_containerd_installed_raw_after.stdout | trim }}
  when: (docker_engine_containerd_installed_version | default('')) | length == 0
  tags: [docker_engine]

- name: Fail if containerd.io could not be installed
  ansible.builtin.fail:
    msg: >-
      Failed to install containerd.io from the Docker repo after trying the
      candidate and fallback versions. The repo may be inconsistent; retry later.
  when: (docker_engine_containerd_installed_version | default('')) | length == 0
  tags: [docker_engine]

- name: Build Docker package version suffixes
  ansible.builtin.set_fact:
    docker_engine_version_suffix: >-
      {{ (docker_engine_version )
      | ternary('=' ~ docker_engine_version, '') }}
    docker_engine_compose_version_suffix: >-
      {{ (docker_engine_compose_version )
      | ternary('=' ~ docker_engine_compose_version, '') }}
  tags: [docker_engine]

- name: Install Docker Engine and plugins
  ansible.builtin.apt:
    name:
      - "containerd.io={{ docker_engine_containerd_installed_version }}"
      - "docker-ce{{ docker_engine_version_suffix }}"
      - "docker-ce-cli{{ docker_engine_version_suffix }}"
      - docker-buildx-plugin
      - "docker-compose-plugin{{ docker_engine_compose_version_suffix }}"
    state: present
    update_cache: true
    cache_valid_time: 0
    force_apt_get: true
  register: docker_engine_install
  retries: 3
  delay: 10
  until: docker_engine_install is succeeded
  tags: [docker_engine]

- name: Ensure docker group users are present
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_engine_users }}"
  tags: [docker_engine]

- name: Ensure Docker config directory exists
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Ensure Docker data root exists
  ansible.builtin.file:
    path: "{{ docker_engine_data_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Configure Docker daemon defaults
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: "0644"
  notify: Restart docker
  tags: [docker_engine]

- name: Ensure Docker services are enabled and running
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - docker
    - containerd
  tags: [docker_engine]
