---
- name: Install Docker apt prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  tags: [docker_engine]

- name: Determine Docker apt architecture
  ansible.builtin.set_fact:
    docker_engine_arch: >-
      {{ docker_engine_arch_map.get(ansible_architecture,
      ansible_architecture) }}
  vars:
    docker_engine_arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armhf
  tags: [docker_engine]

- name: Ensure Docker apt keyring directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Download Docker apt GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
  tags: [docker_engine]

- name: Install Docker apt GPG keyring
  ansible.builtin.command:
    cmd: >-
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      /etc/apt/keyrings/docker.asc
    creates: /etc/apt/keyrings/docker.gpg
  tags: [docker_engine]

- name: Ensure Docker apt keyring permissions
  ansible.builtin.file:
    path: /etc/apt/keyrings/docker.gpg
    owner: root
    group: root
    mode: "0644"
  tags: [docker_engine]

- name: Add Docker apt repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ docker_engine_arch }} signed-by=/etc/apt/keyrings/docker.gpg]
      https://download.docker.com/linux/ubuntu
      {{ docker_engine_apt_release }} stable
    filename: docker
    state: present
    update_cache: false
  tags: [docker_engine]

- name: Refresh apt cache after adding Docker repo
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags: [docker_engine]

- name: Check Docker apt repo availability
  ansible.builtin.command:
    cmd: apt-cache policy docker-ce
  register: docker_engine_repo_check
  changed_when: false
  tags: [docker_engine]

- name: Fail if Docker packages are unavailable
  ansible.builtin.fail:
    msg: >-
      Docker apt repo is configured but docker-ce is not available. Check apt
      update output or set docker_engine_apt_release to a supported Ubuntu
      codename (e.g., jammy).
  when: "'Candidate: (none)' in docker_engine_repo_check.stdout"
  tags: [docker_engine]

- name: Build Docker package version suffixes
  ansible.builtin.set_fact:
    docker_engine_version_suffix: >-
      {{ (docker_engine_version )
      | ternary('=' ~ docker_engine_version, '') }}
    docker_engine_compose_version_suffix: >-
      {{ (docker_engine_compose_version )
      | ternary('=' ~ docker_engine_compose_version, '') }}
  tags: [docker_engine]

- name: Install Docker Engine and plugins
  ansible.builtin.apt:
    name:
      - "docker-ce{{ docker_engine_version_suffix }}"
      - "docker-ce-cli{{ docker_engine_version_suffix }}"
      - containerd.io
      - docker-buildx-plugin
      - "docker-compose-plugin{{ docker_engine_compose_version_suffix }}"
    state: present
    update_cache: true
    cache_valid_time: 3600
  tags: [docker_engine]

- name: Ensure docker group users are present
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_engine_users }}"
  tags: [docker_engine]

- name: Ensure Docker config directory exists
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Ensure Docker data root exists
  ansible.builtin.file:
    path: "{{ docker_engine_data_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [docker_engine]

- name: Configure Docker daemon defaults
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: "0644"
  notify: Restart docker
  tags: [docker_engine]

- name: Ensure Docker services are enabled and running
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - docker
    - containerd
  tags: [docker_engine]
